<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B.Bot - Multi-Functional Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2A2D43;
            --secondary-color: #4A9B8E;
            --accent-color: #F4B942;
            --light-color: #F8F9FA;
            --dark-color: #1A1C28;
            --text-color: #333333;
            --success-color: #4CAF50;
            --warning-color: #FFC107;
            --danger-color: #DC3545;
            --transition: all 0.3s ease;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: var(--light-color);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: var(--primary-color);
            color: white;
            padding: 2rem 1rem;
            position: fixed;
            height: 100%;
        }

        .sidebar-brand {
            font-size: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .nav-item:hover {
            background: var(--secondary-color);
        }

        .main-content {
            margin-left: 250px;
            padding: 2rem;
            width: calc(100% - 250px);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-color);
        }

        /* Image Editor Styles */
        .editor-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
        }

        .canvas-container {
            background: #f0f0f0;
            border-radius: var(--border-radius);
            min-height: 500px;
            position: relative;
        }

        #editorCanvas {
            max-width: 100%;
            cursor: crosshair;
        }

        .editor-tools {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .tool-section {
            background: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .slider-group {
            margin-bottom: 1rem;
        }

        /* Chat Interface */
        .chat-container {
            max-width: 800px;
            margin: 2rem auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            margin-bottom: 1rem;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            padding: 1rem;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.8rem;
            border-radius: var(--border-radius);
            background: var(--light-color);
        }

        .message.user {
            background: var(--secondary-color);
            color: white;
        }

        .chat-input {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        #userInput {
            flex: 1;
            padding: 0.8rem;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
        }

        #imageUploadChat {
            display: none;
        }

        .upload-btn {
            padding: 0.8rem;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .upload-btn:hover {
            background: var(--accent-color);
        }

        .main-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-brand">
                <i class="fas fa-robot"></i>
                <span>B.Bot</span>
            </div>
            <div class="nav-item" data-page="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <div class="nav-item" data-page="image-editor">
                <i class="fas fa-image"></i>
                <span>Image Editor</span>
            </div>
            <div class="nav-item" data-page="chat">
                <i class="fas fa-comments"></i>
                <span>Chat</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Home Page -->
            <div id="home" class="page active">
                <h2>Welcome to B.Bot</h2>
                <p>Choose a feature to get started:</p>
                <div class="main-buttons">
                    <button class="btn btn-primary" data-page="image-editor">
                        <i class="fas fa-image"></i> Image Editor
                    </button>
                    <button class="btn btn-primary" data-page="chat">
                        <i class="fas fa-comments"></i> Chat with B.Bot
                    </button>
                </div>
            </div>

            <!-- Image Editor Page -->
            <div id="image-editor" class="page">
                <div class="image-editor-page">
                    <h2 class="mb-2">Image Editor</h2>
                    <div class="editor-container">
                        <div class="canvas-container">
                            <canvas id="editorCanvas"></canvas>
                            <div class="upload-prompt" id="uploadPrompt">
                                <p>Drag & drop image or click Upload</p>
                                <button class="btn btn-primary" id="uploadButton">
                                    <i class="fas fa-upload"></i> Upload Image
                                </button>
                                <input type="file" id="imageUpload" accept="image/*" hidden>
                            </div>
                        </div>
                        <div class="editor-tools">
                            <div class="tool-section">
                                <h3>AI Tools</h3>
                                <button class="btn btn-primary" id="magicEraser">
                                    <i class="fas fa-magic"></i> Magic Eraser
                                </button>
                                <button class="btn btn-primary" id="removeBackground">
                                    <i class="fas fa-layer-group"></i> Remove Background
                                </button>
                            </div>
                            <div class="tool-section">
                                <h3>Adjustments</h3>
                                <div class="slider-group">
                                    <label>Brightness</label>
                                    <input type="range" min="0" max="200" value="100" id="brightness">
                                </div>
                                <div class="slider-group">
                                    <label>Contrast</label>
                                    <input type="range" min="0" max="200" value="100" id="contrast">
                                </div>
                                <div class="slider-group">
                                    <label>Saturation</label>
                                    <input type="range" min="0" max="200" value="100" id="saturation">
                                </div>
                            </div>
                            <button class="btn btn-primary" id="downloadBtn">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Page -->
            <div id="chat" class="page">
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input">
                        <input type="text" id="userInput" placeholder="Ask me anything or give image editing instructions...">
                        <button class="upload-btn" id="uploadChatButton">
                            <i class="fas fa-upload"></i>
                        </button>
                        <input type="file" id="imageUploadChat" accept="image/*">
                        <button class="btn btn-primary" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Page Navigation
        document.querySelectorAll('.nav-item, .btn[data-page]').forEach(item => {
            item.addEventListener('click', () => {
                const pageId = item.getAttribute('data-page');
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                document.getElementById(pageId).classList.add('active');
            });
        });

        // Image Editor Functionality
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');
        let isErasing = false;
        let isRemovingBackground = false;
        let currentImage = null;
        let eraseRadius = 20; // Adjustable radius for erasing/removing

        // Initialize Image Editor
        document.getElementById('uploadButton').addEventListener('click', () => {
            document.getElementById('imageUpload').click();
        });
        document.getElementById('imageUpload').addEventListener('change', loadImage);

        function loadImage(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    currentImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
                };
                img.src = event.target.result;
                document.getElementById('uploadPrompt').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        // Magic Eraser with Circular Area
        document.getElementById('magicEraser').addEventListener('click', function() {
            isErasing = !isErasing;
            isRemovingBackground = false;
            this.classList.toggle('active', isErasing);
            document.getElementById('removeBackground').classList.remove('active');
        });

        canvas.addEventListener('mousedown', function(e) {
            if (!currentImage) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (isErasing || isRemovingBackground) {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                for (let i = 0; i < imageData.data.length; i += 4) {
                    const px = (i / 4) % canvas.width;
                    const py = Math.floor((i / 4) / canvas.width);
                    const dx = px - x;
                    const dy = py - y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance <= eraseRadius) {
                        if (isErasing) {
                            // Randomize pixels within the circle for magic eraser effect
                            const j = Math.floor(Math.random() * (imageData.data.length / 4)) * 4;
                            [imageData.data[i], imageData.data[j]] = [imageData.data[j], imageData.data[i]];
                            [imageData.data[i + 1], imageData.data[j + 1]] = [imageData.data[j + 1], imageData.data[i + 1]];
                            [imageData.data[i + 2], imageData.data[j + 2]] = [imageData.data[j + 2], imageData.data[i + 2]];
                        } else if (isRemovingBackground) {
                            // Set alpha to 0 for transparent effect within the circle
                            imageData.data[i + 3] = 0;
                        }
                    }
                }
                ctx.putImageData(imageData, 0, 0);
            }
        });

        // Remove Background with Circular Area
        document.getElementById('removeBackground').addEventListener('click', function() {
            isRemovingBackground = !isRemovingBackground;
            isErasing = false;
            this.classList.toggle('active', isRemovingBackground);
            document.getElementById('magicEraser').classList.remove('active');
        });

        // Adjustments
        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', updateFilters);
        });

        function updateFilters() {
            const brightness = document.getElementById('brightness').value;
            const contrast = document.getElementById('contrast').value;
            const saturation = document.getElementById('saturation').value;
            
            canvas.style.filter = `
                brightness(${brightness}%)
                contrast(${contrast}%)
                saturate(${saturation}%)
            `;
        }

        // Programmatic Adjustments
        function setBrightness(value) {
            const slider = document.getElementById('brightness');
            slider.value = value;
            updateFilters();
        }

        function setContrast(value) {
            const slider = document.getElementById('contrast');
            slider.value = value;
            updateFilters();
        }

        function setSaturation(value) {
            const slider = document.getElementById('saturation');
            slider.value = value;
            updateFilters();
        }

        function applyMagicEraser() {
            document.getElementById('magicEraser').click();
        }

        function removeBackground() {
            document.getElementById('removeBackground').click();
        }

        // Download
        document.getElementById('downloadBtn').addEventListener('click', function() {
            const link = document.createElement('a');
            link.download = 'edited-image.png';
            link.href = canvas.toDataURL();
            link.click();
        });

        // Chat Functionality with Gemini API and Image Upload
        const API_KEY = 'AIzaSyBwTNUiVsy3JyifJNmifq9237JmEBkFWSk';
        const chatMessages = document.getElementById('chatMessages');

        // Handle Chat Image Upload
        document.getElementById('uploadChatButton').addEventListener('click', () => {
            document.getElementById('imageUploadChat').click();
        });

        document.getElementById('imageUploadChat').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        currentImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        chatMessages.innerHTML += `
                            <div class="message user">
                                <strong>You:</strong> Uploaded an image.
                            </div>
                        `;
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        async function generateResponse(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are an image editing assistant. Parse the following user input to identify image editing instructions (e.g., adjust brightness, contrast, saturation, apply magic eraser, remove background, clear clouds). If the input is a general question, provide a helpful response. If an image is uploaded, assume the latest instruction applies to that image. Return a JSON object with two fields: 
                                - "response": A string with the chatbot's reply to the user.
                                - "actions": An array of objects, each with "action" (e.g., "setBrightness", "setContrast", "setSaturation", "applyMagicEraser", "removeBackground", "clearClouds") and "value" (if applicable, e.g., brightness value).
                                Input: "${prompt}"`
                            }]
                        }]
                    })
                });

                const data = await response.json();
                const content = data.candidates[0].content.parts[0].text;
                const cleanedContent = content.replace(/```json\n|\n```/g, '');
                return JSON.parse(cleanedContent);
            } catch (error) {
                console.error('Error:', error);
                return {
                    response: "Sorry, I couldn't process your request. Please try again.",
                    actions: []
                };
            }
        }

        document.getElementById('sendButton').addEventListener('click', async () => {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (message || document.getElementById('imageUploadChat').files.length > 0) {
                // Add user message
                chatMessages.innerHTML += `
                    <div class="message user">
                        <strong>You:</strong> ${message || 'Uploaded an image.'}
                    </div>
                `;

                // Generate response
                const { response, actions } = await generateResponse(message || 'No text instruction provided with image upload');
                
                // Add AI response
                chatMessages.innerHTML += `
                    <div class="message">
                        <strong>B.Bot:</strong> ${response}
                    </div>
                `;

                // Execute image editing actions
                if (currentImage && actions.length > 0) {
                    actions.forEach(({ action, value }) => {
                        switch (action) {
                            case 'setBrightness':
                                setBrightness(value || 100);
                                break;
                            case 'setContrast':
                                setContrast(value || 100);
                                break;
                            case 'setSaturation':
                                setSaturation(value || 100);
                                break;
                            case 'applyMagicEraser':
                                applyMagicEraser();
                                break;
                            case 'removeBackground':
                            case 'clearClouds':
                                removeBackground();
                                break;
                            default:
                                console.warn(`Unknown action: ${action}`);
                        }
                    });
                    // Add working download option
                    const downloadBtn = document.createElement('button');
                    downloadBtn.className = 'btn btn-primary';
                    downloadBtn.textContent = 'Download Edited Image';
                    downloadBtn.addEventListener('click', function() {
                        const link = document.createElement('a');
                        link.download = 'edited-image.png';
                        link.href = canvas.toDataURL('image/png');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    });
                    const downloadMessage = document.createElement('div');
                    downloadMessage.className = 'message';
                    downloadMessage.innerHTML = `<strong>B.Bot:</strong> Image updated! `;
                    downloadMessage.appendChild(downloadBtn);
                    chatMessages.appendChild(downloadMessage);
                } else if (actions.length > 0 && !currentImage) {
                    chatMessages.innerHTML += `
                        <div class="message">
                            <strong>B.Bot:</strong> Please upload an image first to apply editing instructions.
                        </div>
                    `;
                }

                // Clear input
                userInput.value = '';
                document.getElementById('imageUploadChat').value = '';
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        });
    </script>
</body>
</html>